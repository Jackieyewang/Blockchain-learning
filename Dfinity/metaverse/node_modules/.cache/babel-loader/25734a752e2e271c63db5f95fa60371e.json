{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = caller;\nexports.call = call;\n\nvar _shortid = require('shortid');\n\nvar _shortid2 = _interopRequireDefault(_shortid);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction caller(funcName, opts) {\n  opts = opts || {};\n  var addListener = opts.addListener || window.addEventListener;\n  var removeListener = opts.removeListener || window.removeEventListener;\n  var postMessage = opts.postMessage || window.postMessage;\n  var targetOrigin = opts.targetOrigin || '*';\n\n  var getMessageData = opts.getMessageData || function (event) {\n    return event.data;\n  };\n\n  return function () {\n    var msg = {\n      sender: 'postmsg-rpc/client',\n      id: (0, _shortid2.default)(),\n      func: funcName,\n      args: Array.from(arguments)\n    };\n    var cancel = void 0;\n    var response = new Promise(function (resolve, reject) {\n      var handler = function handler() {\n        var data = getMessageData.apply(null, arguments);\n        if (!data) return;\n        if (data.sender !== 'postmsg-rpc/server' || data.id !== msg.id) return;\n        removeListener('message', handler);\n\n        if (data.err) {\n          var err = new Error('Unexpected error calling ' + funcName);\n          Object.assign(err, data.err);\n          return reject(err);\n        }\n\n        resolve(data.res);\n      };\n\n      cancel = function cancel() {\n        removeListener('message', handler);\n        var err = new Error('Canceled call to ' + funcName);\n        err.isCanceled = true;\n        reject(err);\n      };\n\n      addListener('message', handler);\n      postMessage(msg, targetOrigin);\n    });\n\n    response.cancel = function () {\n      return cancel();\n    };\n\n    return response;\n  };\n}\n\nfunction call(funcName) {\n  return caller(funcName).apply(null, [].slice.call(arguments, 1));\n}","map":{"version":3,"sources":["../src/client.js"],"names":["caller","opts","addListener","window","removeListener","postMessage","targetOrigin","getMessageData","event","msg","sender","id","func","args","Array","cancel","response","handler","data","err","Object","reject","resolve","call"],"mappings":";;;;;kBAEwBA,M;QAoDRuB,I,GAAAA,I;;AAtDhB,IAAA,QAAA,GAAA,OAAA,CAAA,SAAA,CAAA;;;;;;;;;;AAEe,SAAA,MAAA,CAAA,QAAA,EAAA,IAAA,EAAiC;AAC9CtB,EAAAA,IAAAA,GAAOA,IAAAA,IAAPA,EAAAA;AAEA,MAAMC,WAAAA,GAAcD,IAAAA,CAAAA,WAAAA,IAAoBE,MAAAA,CAAxC,gBAAA;AACA,MAAMC,cAAAA,GAAiBH,IAAAA,CAAAA,cAAAA,IAAuBE,MAAAA,CAA9C,mBAAA;AACA,MAAME,WAAAA,GAAcJ,IAAAA,CAAAA,WAAAA,IAAoBE,MAAAA,CAAxC,WAAA;AACA,MAAMG,YAAAA,GAAeL,IAAAA,CAAAA,YAAAA,IAArB,GAAA;;AACA,MAAMM,cAAAA,GAAiBN,IAAAA,CAAAA,cAAAA,IAAwB,UAAA,KAAA,EAAA;AAAA,WAAWO,KAAAA,CAAX,IAAA;AAA/C,GAAA;;AAEA,SAAO,YAAY;AACjB,QAAMC,GAAAA,GAAM;AACVC,MAAAA,MAAAA,EADU,oBAAA;AAEVC,MAAAA,EAAAA,EAAI,CAAA,GAAA,SAAA,CAFM,OAEN,GAFM;AAGVC,MAAAA,IAAAA,EAHU,QAAA;AAIVC,MAAAA,IAAAA,EAAMC,KAAAA,CAAAA,IAAAA,CAAAA,SAAAA;AAJI,KAAZ;AAOA,QAAIC,MAAAA,GAAAA,KAAJ,CAAA;AAEA,QAAMC,QAAAA,GAAW,IAAA,OAAA,CAAY,UAAA,OAAA,EAAA,MAAA,EAAqB;AAChD,UAAMC,OAAAA,GAAU,SAAVA,OAAU,GAAY;AAC1B,YAAMC,IAAAA,GAAOX,cAAAA,CAAAA,KAAAA,CAAAA,IAAAA,EAAb,SAAaA,CAAb;AACA,YAAI,CAAJ,IAAA,EAAW;AACX,YAAIW,IAAAA,CAAAA,MAAAA,KAAAA,oBAAAA,IAAwCA,IAAAA,CAAAA,EAAAA,KAAYT,GAAAA,CAAxD,EAAA,EAAgE;AAChEL,QAAAA,cAAAA,CAAAA,SAAAA,EAAAA,OAAAA,CAAAA;;AAEA,YAAIc,IAAAA,CAAJ,GAAA,EAAc;AACZ,cAAMC,GAAAA,GAAM,IAAA,KAAA,CAAA,8BAAZ,QAAY,CAAZ;AACAC,UAAAA,MAAAA,CAAAA,MAAAA,CAAAA,GAAAA,EAAmBF,IAAAA,CAAnBE,GAAAA;AACA,iBAAOC,MAAAA,CAAP,GAAOA,CAAP;AACD;;AAEDC,QAAAA,OAAAA,CAAQJ,IAAAA,CAARI,GAAAA,CAAAA;AAZF,OAAA;;AAeAP,MAAAA,MAAAA,GAAS,SAAA,MAAA,GAAM;AACbX,QAAAA,cAAAA,CAAAA,SAAAA,EAAAA,OAAAA,CAAAA;AACA,YAAMe,GAAAA,GAAM,IAAA,KAAA,CAAA,sBAAZ,QAAY,CAAZ;AACAA,QAAAA,GAAAA,CAAAA,UAAAA,GAAAA,IAAAA;AACAE,QAAAA,MAAAA,CAAAA,GAAAA,CAAAA;AAJFN,OAAAA;;AAOAb,MAAAA,WAAAA,CAAAA,SAAAA,EAAAA,OAAAA,CAAAA;AACAG,MAAAA,WAAAA,CAAAA,GAAAA,EAAAA,YAAAA,CAAAA;AAxBF,KAAiB,CAAjB;;AA2BAW,IAAAA,QAAAA,CAAAA,MAAAA,GAAkB,YAAA;AAAA,aAAMD,MAAN,EAAA;AAAlBC,KAAAA;;AAEA,WAAA,QAAA;AAvCF,GAAA;AAyCD;;AAEM,SAAA,IAAA,CAAA,QAAA,EAAyB;AAC9B,SAAOhB,MAAAA,CAAAA,QAAAA,CAAAA,CAAAA,KAAAA,CAAAA,IAAAA,EAA6B,GAAA,KAAA,CAAA,IAAA,CAAA,SAAA,EAApC,CAAoC,CAA7BA,CAAP;AACD","sourcesContent":["import shortid from 'shortid'\n\nexport default function caller (funcName, opts) {\n  opts = opts || {}\n\n  const addListener = opts.addListener || window.addEventListener\n  const removeListener = opts.removeListener || window.removeEventListener\n  const postMessage = opts.postMessage || window.postMessage\n  const targetOrigin = opts.targetOrigin || '*'\n  const getMessageData = opts.getMessageData || ((event) => event.data)\n\n  return function () {\n    const msg = {\n      sender: 'postmsg-rpc/client',\n      id: shortid(),\n      func: funcName,\n      args: Array.from(arguments)\n    }\n\n    let cancel\n\n    const response = new Promise((resolve, reject) => {\n      const handler = function () {\n        const data = getMessageData.apply(null, arguments)\n        if (!data) return\n        if (data.sender !== 'postmsg-rpc/server' || data.id !== msg.id) return\n        removeListener('message', handler)\n\n        if (data.err) {\n          const err = new Error(`Unexpected error calling ${funcName}`)\n          Object.assign(err, data.err)\n          return reject(err)\n        }\n\n        resolve(data.res)\n      }\n\n      cancel = () => {\n        removeListener('message', handler)\n        const err = new Error(`Canceled call to ${funcName}`)\n        err.isCanceled = true\n        reject(err)\n      }\n\n      addListener('message', handler)\n      postMessage(msg, targetOrigin)\n    })\n\n    response.cancel = () => cancel()\n\n    return response\n  }\n}\n\nexport function call (funcName) {\n  return caller(funcName).apply(null, [].slice.call(arguments, 1))\n}\n"]},"metadata":{},"sourceType":"script"}