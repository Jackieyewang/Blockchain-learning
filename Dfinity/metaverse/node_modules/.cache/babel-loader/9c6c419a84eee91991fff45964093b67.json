{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.DidProvider = exports.didMethods = void 0;\n\nconst dag_jose_utils_1 = require(\"dag-jose-utils\");\n\nconst did_jwt_1 = require(\"did-jwt\");\n\nconst rpc_utils_1 = require(\"rpc-utils\");\n\nconst utils_1 = require(\"./utils\");\n\nfunction toGeneralJWS(jws) {\n  const [protectedHeader, payload, signature] = jws.split('.');\n  return {\n    payload,\n    signatures: [{\n      protected: protectedHeader,\n      signature\n    }]\n  };\n}\n\nfunction sign(payload, didWithFragment, keyring, threeIdx, protectedHeader = {}, revocable) {\n  return __awaiter(this, void 0, void 0, function* () {\n    let [did, keyFragment] = didWithFragment.split('#');\n    let kid, signer;\n\n    if (did.startsWith('did:key:')) {\n      const pubkey = did.split(':')[2];\n      kid = `${did}#${pubkey}`;\n      signer = keyring.getMgmtSigner(pubkey);\n    } else {\n      if (did !== threeIdx.id) throw new Error(`Unknown DID: ${did}`);\n      const version = threeIdx.get3idVersion();\n      if (!keyFragment) keyFragment = keyring.getKeyFragment(version);\n      kid = `${did}${revocable ? '' : `?version-id=${version}`}#${keyFragment}`;\n      signer = keyring.getSigner(version);\n    }\n\n    const header = utils_1.toStableObject(Object.assign(protectedHeader, {\n      kid\n    }));\n    const jws = yield did_jwt_1.createJWS(utils_1.toStableObject(payload), signer, header);\n    return toGeneralJWS(jws);\n  });\n}\n\nexports.didMethods = {\n  did_authenticate: ({\n    permissions,\n    keyring,\n    threeIdx,\n    origin,\n    forcedDID\n  }, params) => __awaiter(void 0, void 0, void 0, function* () {\n    const paths = yield permissions.request(origin, params.paths || []);\n    if (paths === null) throw new rpc_utils_1.RPCError(4001, 'User Rejected Request');\n    return sign({\n      did: forcedDID || threeIdx.id,\n      aud: params.aud,\n      nonce: params.nonce,\n      paths,\n      exp: Math.floor(Date.now() / 1000) + 600\n    }, forcedDID || threeIdx.id, keyring, threeIdx);\n  }),\n  did_createJWS: ({\n    permissions,\n    keyring,\n    threeIdx,\n    origin\n  }, params) => __awaiter(void 0, void 0, void 0, function* () {\n    if (!permissions.has(origin)) throw new rpc_utils_1.RPCError(4100, 'Unauthorized');\n    const jws = yield sign(params.payload, params.did, keyring, threeIdx, params.protected, params.revocable);\n    return {\n      jws\n    };\n  }),\n  did_decryptJWE: ({\n    permissions,\n    keyring,\n    origin\n  }, params) => __awaiter(void 0, void 0, void 0, function* () {\n    if (!permissions.has(origin)) throw new rpc_utils_1.RPCError(4100, 'Unauthorized');\n    const parsedKids = utils_1.parseJWEKids(params.jwe);\n    const decrypter = keyring.getAsymDecrypter(parsedKids);\n    const bytes = yield did_jwt_1.decryptJWE(params.jwe, decrypter);\n    let obj;\n\n    try {\n      obj = dag_jose_utils_1.decodeCleartext(bytes);\n    } catch (e) {}\n\n    if (obj && !permissions.has(origin, obj.paths)) throw new rpc_utils_1.RPCError(4100, 'Unauthorized');\n    return {\n      cleartext: utils_1.encodeBase64(bytes)\n    };\n  })\n};\n\nclass DidProvider {\n  constructor({\n    permissions,\n    threeIdx,\n    keyring,\n    forcedOrigin,\n    forcedDID\n  }) {\n    const handler = rpc_utils_1.createHandler(exports.didMethods);\n\n    this._handle = (origin, msg) => __awaiter(this, void 0, void 0, function* () {\n      return yield handler({\n        origin: forcedOrigin !== null && forcedOrigin !== void 0 ? forcedOrigin : origin,\n        permissions,\n        threeIdx,\n        keyring,\n        forcedDID\n      }, msg);\n    });\n  }\n\n  get isDidProvider() {\n    return true;\n  }\n\n  send(msg, origin) {\n    return __awaiter(this, void 0, void 0, function* () {\n      return yield this._handle(origin !== null && origin !== void 0 ? origin : '', msg);\n    });\n  }\n\n}\n\nexports.DidProvider = DidProvider;","map":{"version":3,"sources":["../src/did-provider.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.DidProvider = exports.didMethods = void 0;\nconst dag_jose_utils_1 = require(\"dag-jose-utils\");\nconst did_jwt_1 = require(\"did-jwt\");\nconst rpc_utils_1 = require(\"rpc-utils\");\nconst utils_1 = require(\"./utils\");\nfunction toGeneralJWS(jws) {\n    const [protectedHeader, payload, signature] = jws.split('.');\n    return {\n        payload,\n        signatures: [{ protected: protectedHeader, signature }],\n    };\n}\nfunction sign(payload, didWithFragment, keyring, threeIdx, protectedHeader = {}, revocable) {\n    return __awaiter(this, void 0, void 0, function* () {\n        let [did, keyFragment] = didWithFragment.split('#');\n        let kid, signer;\n        if (did.startsWith('did:key:')) {\n            const pubkey = did.split(':')[2];\n            kid = `${did}#${pubkey}`;\n            signer = keyring.getMgmtSigner(pubkey);\n        }\n        else {\n            if (did !== threeIdx.id)\n                throw new Error(`Unknown DID: ${did}`);\n            const version = threeIdx.get3idVersion();\n            if (!keyFragment)\n                keyFragment = keyring.getKeyFragment(version);\n            kid = `${did}${revocable ? '' : `?version-id=${version}`}#${keyFragment}`;\n            signer = keyring.getSigner(version);\n        }\n        const header = utils_1.toStableObject(Object.assign(protectedHeader, { kid }));\n        const jws = yield did_jwt_1.createJWS(utils_1.toStableObject(payload), signer, header);\n        return toGeneralJWS(jws);\n    });\n}\nexports.didMethods = {\n    did_authenticate: ({ permissions, keyring, threeIdx, origin, forcedDID }, params) => __awaiter(void 0, void 0, void 0, function* () {\n        const paths = yield permissions.request(origin, params.paths || []);\n        if (paths === null)\n            throw new rpc_utils_1.RPCError(4001, 'User Rejected Request');\n        return sign({\n            did: forcedDID || threeIdx.id,\n            aud: params.aud,\n            nonce: params.nonce,\n            paths,\n            exp: Math.floor(Date.now() / 1000) + 600,\n        }, forcedDID || threeIdx.id, keyring, threeIdx);\n    }),\n    did_createJWS: ({ permissions, keyring, threeIdx, origin }, params) => __awaiter(void 0, void 0, void 0, function* () {\n        if (!permissions.has(origin))\n            throw new rpc_utils_1.RPCError(4100, 'Unauthorized');\n        const jws = yield sign(params.payload, params.did, keyring, threeIdx, params.protected, params.revocable);\n        return { jws };\n    }),\n    did_decryptJWE: ({ permissions, keyring, origin }, params) => __awaiter(void 0, void 0, void 0, function* () {\n        if (!permissions.has(origin))\n            throw new rpc_utils_1.RPCError(4100, 'Unauthorized');\n        const parsedKids = utils_1.parseJWEKids(params.jwe);\n        const decrypter = keyring.getAsymDecrypter(parsedKids);\n        const bytes = yield did_jwt_1.decryptJWE(params.jwe, decrypter);\n        let obj;\n        try {\n            obj = dag_jose_utils_1.decodeCleartext(bytes);\n        }\n        catch (e) {\n        }\n        if (obj && !permissions.has(origin, obj.paths))\n            throw new rpc_utils_1.RPCError(4100, 'Unauthorized');\n        return { cleartext: utils_1.encodeBase64(bytes) };\n    }),\n};\nclass DidProvider {\n    constructor({ permissions, threeIdx, keyring, forcedOrigin, forcedDID }) {\n        const handler = rpc_utils_1.createHandler(exports.didMethods);\n        this._handle = (origin, msg) => __awaiter(this, void 0, void 0, function* () {\n            return yield handler({\n                origin: forcedOrigin !== null && forcedOrigin !== void 0 ? forcedOrigin : origin,\n                permissions,\n                threeIdx,\n                keyring,\n                forcedDID,\n            }, msg);\n        });\n    }\n    get isDidProvider() {\n        return true;\n    }\n    send(msg, origin) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this._handle(origin !== null && origin !== void 0 ? origin : '', msg);\n        });\n    }\n}\nexports.DidProvider = DidProvider;\n//# sourceMappingURL=did-provider.js.map"]},"metadata":{},"sourceType":"script"}